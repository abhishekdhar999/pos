<div class="filters">
  <label>
    Order ID:
    <input type="number" [(ngModel)]="filter.orderId" placeholder="Search by ID" />
  </label>

  <label>
    Status:
    <select [(ngModel)]="filter.status">
      <option value="">All</option>
      <option value="CREATED">Created</option>
      <option value="FULFILLABLE">Fulfillable</option>
      <option value="UNFULFILLABLE">Unfulfillable</option>
    </select>
  </label>

  <label>
    Start Date:
    <input type="date" [(ngModel)]="filter.startDate" />
  </label>

  <label>
    End Date:
    <input type="date" [(ngModel)]="filter.endDate" />
  </label>

  <button type="button" (click)="applyFilters()">Apply Filters</button>

<!--  @if (isSupervisor) {-->
    <button type="button" class="create-order-btn" (click)="openCreateOrderModal()">
      ‚ûï Create Order
    </button>
<!--  }-->

  <button type="button" class="resync-all-btn" (click)="resyncAllOrders()" [disabled]="resyncingAll">
    @if (resyncingAll) {
      ‚è≥ Resyncing All...
    } @else {
      üîÑ Resync All Orders
    }
  </button>
</div>

<section class="orders">
  @if (loading) {
    <p>Loading...</p>
  } @else {
    <table>
      <thead>
      <tr>
        <th>Order ID</th>
        <th>Status</th>
        <th>Created At</th>
        <th>Actions</th>
      </tr>
      </thead>
      <tbody>
        @for (order of orders; track order.id) {
          <tr>
            <td>{{ order.id }}</td>
            <td>{{ order.status }}</td>
            <td>{{ order.dateTime | date: 'short' }}</td>
            <td>
              <div class="action-buttons">

                @if (order.status === 'FULFILLABLE') {
                  <button
                    type="button"
                    class="invoice-btn"
                    (click)="generateInvoice(order.id)"
                    [disabled]="generatingInvoice === order.id"
                    title="Generate Invoice">
                    @if (generatingInvoice === order.id) {
                      ‚è≥ Generating...
                    } @else {
                      üìÑ Generate Invoice
                    }
                  </button>
                }

                <button
                  type="button"
                  class="resync-btn"
                  (click)="resyncOrder(order.id)"
                  [disabled]="resyncingOrders.has(order.id)"
                  title="Resync Order">
                  @if (resyncingOrders.has(order.id)) {
                    ‚è≥ Resyncing...
                  } @else {
                    üîÑ Resync
                  }
                </button>
              </div>
            </td>
          </tr>
        } @empty {
          <tr>
            <td colspan="4">No orders found</td>
          </tr>
        }
      </tbody>
    </table>
  }
</section>

<div class="pagination">
  <button type="button" (click)="prevPage()" [disabled]="filter.page === 0">Prev</button>
  <span>Page {{ filter.page + 1 }} of {{ totalPages }}</span>
  <button
    type="button"
    (click)="nextPage()"
    [disabled]="filter.page >= totalPages - 1"
  >
    Next
  </button>
</div>

<!-- Create Order Modal -->
@if (showCreateOrderModal) {
  <div class="modal-overlay" (click)="closeCreateOrderModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Create New Order</h2>
        <button type="button" class="close-btn" (click)="closeCreateOrderModal()">√ó</button>
      </div>

      <div class="modal-body">
        <!-- Product Selection -->
        <div class="form-group">
          <label>Select Product by Barcode:</label>
          <select [(ngModel)]="selectedBarcode" (change)="onBarcodeChange()" class="barcode-select">
            <option value="">-- Select Product --</option>
            @for (product of availableProducts; track product.barcode) {
              <option [value]="product.barcode">
                {{ product.barcode }} - {{ product.name }} (‚Çπ{{ product.price }})
              </option>
            }
          </select>
        </div>

        @if (selectedProduct) {
          <div class="selected-product">
            <h3>Selected Product:</h3>
            <div class="product-info">
              <span class="product-name">{{ selectedProduct.name }}</span>
              <span class="product-barcode">Barcode: {{ selectedProduct.barcode }}</span>
              <span class="product-price">Price: ‚Çπ{{ selectedProduct.price }}</span>
              <span class="product-quantity">Available: {{ selectedProduct.quantity }}</span>
            </div>

            <div class="quantity-controls">
              <label>Quantity:</label>
              <div class="quantity-input">
                <button type="button" (click)="decreaseQuantity()" [disabled]="orderQuantity <= 1">-</button>
                <input type="number" [(ngModel)]="orderQuantity" min="1" [max]="selectedProduct.quantity" />
                <button type="button" (click)="increaseQuantity()" [disabled]="orderQuantity >= selectedProduct.quantity">+</button>
              </div>
            </div>

            <button type="button" class="add-to-cart-btn" (click)="addToCart()" >
              Add to Cart
            </button>
          </div>
        }

        <!-- Cart Items -->
        @if (cartItems.length > 0) {
          <div class="cart-section">
            <h3>Shopping Cart ({{ cartItems.length }} items)</h3>
            <div class="cart-items">
              @for (item of cartItems; track item.barcode) {
                <div class="cart-item">
                  <div class="item-info">
                    <span class="item-name">{{ item.name }}</span>
                    <span class="item-barcode">{{ item.barcode }}</span>
                  </div>
                  <div class="item-controls">
                    <span class="item-quantity">Qty: {{ item.quantity }}</span>
                    <span class="item-price">‚Çπ{{ item.price * item.quantity }}</span>
                    <button type="button" class="remove-btn" (click)="removeFromCart(item.barcode)">Remove</button>
                  </div>
                </div>
              }
            </div>

            <div class="cart-total">
              <strong>Total: ‚Çπ{{ getCartTotal() }}</strong>
            </div>
          </div>
        }
      </div>

      <div class="modal-footer">
        <button type="button" class="cancel-btn" (click)="closeCreateOrderModal()">Cancel</button>
        <button type="button" class="create-order-btn" (click)="createOrder()" >
          Create Order ({{ cartItems.length }} items)
        </button>
      </div>
    </div>
  </div>
}
