
<div class="product-dashboard">
  <!-- Header Section -->
  <div class="dashboard-header">
    <div class="header-content">
      <h1 class="dashboard-title">
        <span class="icon">üì¶</span>
        Product Management
      </h1>
      <p class="dashboard-subtitle">Manage your product catalog and inventory efficiently</p>
    </div>


    @if (isSupervisor) {
      <div class="header-actions">
        <!-- Add Product Dropdown -->
        <div class="dropdown-container" (click)="onDropdownClick($event)">
          <button class="action-btn primary" (click)="toggleAddProductDropdown()">
            <span class="btn-icon">‚ûï</span>
            Add Product
            <span class="dropdown-arrow">‚ñº</span>
          </button>

          @if (showAddProductDropdown) {
            <div class="dropdown-menu">
              <button class="dropdown-item" (click)="openSingleProductModal()">
                <span class="item-icon">üìù</span>
                Add Single Product
              </button>
              <button class="dropdown-item" (click)="openBulkProductModal()">
                <span class="item-icon">üìÅ</span>
                Bulk Upload Products
              </button>
            </div>
          }
        </div>

        <!-- Inventory Dropdown -->
        <div class="dropdown-container" (click)="onDropdownClick($event)">
          <button class="action-btn secondary" (click)="toggleInventoryDropdown()">
            <span class="btn-icon">üìä</span>
            Inventory
            <span class="dropdown-arrow">‚ñº</span>
          </button>

          @if (showInventoryDropdown) {
            <div class="dropdown-menu">
              <button class="dropdown-item" (click)="openSingleInventoryModal()">
                <span class="item-icon">üìù</span>
                Add Single Inventory
              </button>
              <button class="dropdown-item" (click)="openBulkInventoryModal()">
                <span class="item-icon">üìÅ</span>
                Bulk Upload Inventory
              </button>
            </div>
          }
        </div>
      </div>
    }
  </div>

  <!-- Search Bar -->
  <div class="search-section">
    <div class="search-container">
      <div class="search-input-group">
        <input
          type="text"
          [(ngModel)]="searchKeyword"
          (input)="onSearchChange()"
          placeholder="Search products by barcode."
          class="search-input"
        />
        <button class="search-btn" (click)="onSearchChange()">
          <span class="search-icon">üîç</span>
        </button>
        @if (searchKeyword) {
          <button class="clear-btn" (click)="clearSearch()">
            <span class="clear-icon">‚úï</span>
          </button>
        }
      </div>

      <!-- Search Results Dropdown -->
      @if (showSearchResults && searchResults.length > 0) {
        <div class="search-results-dropdown">
          @for (result of searchResults; track result) {
            <div class="search-result-item" (click)="selectSearchResult(result)">
              <span class="result-text">{{ result }}</span>
            </div>
          }
        </div>
      }

      @if (searchKeyword && !showSearchResults) {
        <div class="search-info">
          <span class="search-results">Searching for: "{{ searchKeyword }}"</span>
        </div>
      }
    </div>
  </div>

<!--  all modals-->

  <!-- Single Inventory Modal -->
  @if (showSingleInventoryModal) {
    <div class="modal-backdrop" (click)="closeSingleInventoryModal()"></div>
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">
          <span class="modal-icon">üìä</span>
          Add Inventory
        </h2>
        <button class="modal-close" (click)="closeSingleInventoryModal()">√ó</button>
      </div>

      <form [formGroup]="inventoryForm" (ngSubmit)="onSubmitInventory()" class="modal-form">
        <div class="form-group">
          <label for="inventoryProduct" class="form-label">Barcode</label>
          <select id="inventoryProduct" formControlName="barcode" class="form-input">
            <option value="">Select a barcode</option>
            @for (product of products; track product.barcode) {
              <option [value]="product.barcode">{{ product.barcode }}</option>
            }
          </select>
        </div>

        <div class="form-group">
          <label for="inventoryQuantity" class="form-label">Quantity</label>
          <input
            id="inventoryQuantity"
            type="number"
            formControlName="quantity"
            placeholder="0"
            class="form-input"
            min="0"
          />
        </div>


        <div class="modal-actions">
          <button type="button" class="btn-secondary" (click)="closeSingleInventoryModal()">
            Cancel
          </button>
          <button type="submit" class="btn-primary"  (click)="onSubmitInventory()">
            <span class="btn-icon">üíæ</span>
            Add Inventory
          </button>
        </div>
      </form>
    </div>
  }
  <!-- Single Product Modal -->
  @if (showSingleProductModal) {
    <div class="modal-backdrop" (click)="closeSingleProductModal()"></div>
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">
          <span class="modal-icon">‚ûï</span>
          Add New Product
        </h2>
        <button class="modal-close" (click)="closeSingleProductModal()">√ó</button>
      </div>

      <form [formGroup]="productForm" (ngSubmit)="onSubmitProduct()" class="modal-form">
        <div class="form-group">
          <label for="productName" class="form-label">Product Name</label>
          <input
            id="productName"
            type="text"
            formControlName="name"
            placeholder="Enter product name"
            class="form-input"
          />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="productPrice" class="form-label">Price</label>
            <input
              id="productPrice"
              type="number"
              formControlName="price"
              placeholder="0.00"
              class="form-input"
              step="0.01"
              min="0"
            />
          </div>

        </div>

        <div class="form-group">
          <label for="productBarcode" class="form-label">Barcode</label>
          <input
            id="productBarcode"
            type="text"
            formControlName="barcode"
            placeholder="Enter barcode"
            class="form-input"

          />
        </div>

        <div class="form-group">
          <label for="productImage" class="form-label">Image URL</label>
          <input
            id="productImage"
            type="url"
            formControlName="imageUrl"
            placeholder="https://example.com/image.jpg"
            class="form-input"
          />
        </div>

        <div class="form-group">
          <label for="productClient" class="form-label">Client Name</label>
          <input
            id="productClient"
            type="text"
            formControlName="clientName"
            placeholder="Enter client name"
            class="form-input"
          />
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-secondary" (click)="closeSingleProductModal()">
            Cancel
          </button>
          <button type="submit" class="btn-primary">
            <span class="btn-icon">üíæ</span>
            Save Product
          </button>
        </div>
      </form>
    </div>
  }

  <!-- Bulk Product Upload Modal -->
  @if (showBulkProductModal) {


<!--    <div class="modal-backdrop" (click)="closeBulkProductModal()"></div>-->
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">
          <span class="modal-icon">üìÅ</span>
          Bulk Upload Products
        </h2>
        <button class="modal-close" (click)="closeBulkProductModal()">√ó</button>
      </div>


      <div class="modal-content">
        <div class="upload-instructions">
          <h3>Instructions:</h3>
          <ul>
            <li>Upload a TSV (Tab-Separated Values) file with product data</li>
            <li>Required columns: <strong>Name</strong>, <strong>Barcode</strong>, <strong>Price</strong>, <strong>ImageUrl</strong>, <strong>ClientName</strong></li>
            <li>First row should contain headers</li>
            <li>Example format: <code>name	barcode	price	imageUrl	clientName</code></li>
          </ul>

          <div class="sample-file-section">
            <p><strong>Need a sample file?</strong></p>
            <button type="button" class="btn-secondary" (click)="downloadSampleProductFile()">
              <span class="btn-icon">üìÑ</span>
              Download Sample TSV File
            </button>
          </div>
        </div>

        <div class="file-upload-area">
          <input
            type="file"
            accept=".tsv,.csv,.xlsx,.xls"
            (change)="onFileSelected($event)"
            class="file-input"
            id="productFile"
          />
          <label for="productFile" class="file-label">
            <span class="file-icon">üìÅ</span>
            <span class="file-text">Choose file or drag and drop</span>
          </label>
        </div>

        @if (selectedFile) {
          <div class="selected-file">
            <span class="file-name">{{ selectedFile.name }}</span>
            <span class="file-size">({{ selectedFile.size  }})</span>
          </div>
        }

        <!-- Results Download Section -->
        @if(allUploadResults.length > 0){
          <div class="error-section">
            <div class="error-actions">
              <button (click)="downloadErrors()" class="btn-secondary">
                ‚¨á Download Upload Report ({{ uploadSuccesses.length }} success, {{ uploadErrors.length }} errors)
              </button>
              <button (click)="clearErrors()" class="btn-secondary">
                üóëÔ∏è Clear Results
              </button>
            </div>
          </div>
        }

        <div class="modal-actions">
          <button type="button" class="btn-secondary" (click)="closeBulkProductModal()">
            Cancel
          </button>
          <button
            type="button"
            class="btn-primary"
            (click)="uploadBulkProducts()"
            [disabled]="!selectedFile">
            <span class="btn-icon">üì§</span>
            Upload Products
          </button>
        </div>
      </div>
    </div>
  }


  <!-- Bulk Inventory Upload Modal -->
  @if (showBulkInventoryModal) {
    <div class="modal-backdrop" (click)="closeBulkInventoryModal()"></div>
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">
          <span class="modal-icon">üìÅ</span>
          Bulk Upload Inventory
        </h2>
        <button class="modal-close" (click)="closeBulkInventoryModal()">√ó</button>
      </div>

      <div class="modal-content">
        <div class="upload-instructions">
          <h3>Instructions:</h3>
          <ul>
            <li>Upload a TSV (Tab-Separated Values) file with inventory data</li>
            <li>Required columns: <strong>Barcode</strong>, <strong>Quantity</strong></li>
            <li>First row should contain headers</li>
            <li>Example format: <code>barcode	quantity</code></li>
          </ul>

          <div class="sample-file-section">
            <p><strong>Need a sample file?</strong></p>
            <button type="button" class="btn-secondary" (click)="downloadSampleInventoryFile()">
              <span class="btn-icon">üìÑ</span>
              Download Sample TSV File
            </button>
          </div>
        </div>

        <div class="file-upload-area">
          <input
            type="file"
            accept=".tsv,.csv,.xlsx,.xls"
            (change)="onInventoryFileSelected($event)"
            class="file-input"
            id="inventoryFile"
          />
          <label for="inventoryFile" class="file-label">
            <span class="file-icon">üìÅ</span>
            <span class="file-text">Choose file or drag and drop</span>
          </label>
        </div>

        @if (inventoryFile) {
          <div class="selected-file">
            <span class="file-name">{{ inventoryFile.name }}</span>
            <span class="file-size">({{ inventoryFile.size }})</span>
          </div>
        }

        <!-- Results Download Section -->
        @if(allUploadResults.length > 0){
          <div class="error-section">
            <div class="error-actions">
              <button (click)="downloadErrors()" class="btn-secondary">
                ‚¨á Download Upload Report ({{ uploadSuccesses.length }} success, {{ uploadErrors.length }} errors)
              </button>
              <button (click)="clearErrors()" class="btn-secondary">
                üóëÔ∏è Clear Results
              </button>
            </div>
          </div>
        }

        <div class="modal-actions">
          <button type="button" class="btn-secondary" (click)="closeBulkInventoryModal()">
            Cancel
          </button>
          <button
            type="button"
            class="btn-primary"
            (click)="uploadBulkInventory()"
            [disabled]="!inventoryFile">
            <span class="btn-icon">üì§</span>
            Upload Inventory
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Update Product Modal -->
  @if (selectedProduct) {
    <div class="modal-backdrop" (click)="closeUpdateModal()"></div>
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">
          <span class="modal-icon">‚úèÔ∏è</span>
          Update Product
        </h2>
        <button class="modal-close" (click)="closeUpdateModal()">√ó</button>
      </div>

      <form (ngSubmit)="updateProduct()" class="modal-form">
        <div class="form-group">
          <label for="updateName" class="form-label">Product Name</label>
          <input
            id="updateName"
            type="text"
            [(ngModel)]="selectedProduct.name"
            name="name"
            required
            class="form-input"
          />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="updatePrice" class="form-label">Price</label>
            <input
              id="updatePrice"
              type="number"
              [(ngModel)]="selectedProduct.price"
              name="price"
              required
              class="form-input"
              step="0.01"
              min="0"
            />
          </div>

        </div>

        <div class="form-group">
          <label for="updateBarcode" class="form-label">Barcode</label>
          <input
            id="updateBarcode"
            type="text"
            [(ngModel)]="selectedProduct.barcode"
            name="barcode"
            required
            class="form-input"
            readonly
            title="Barcode cannot be changed once set"
            disabled
          />
        </div>

        <div class="form-group">
          <label for="updateImage" class="form-label">Image URL</label>
          <input
            id="updateImage"
            type="url"
            [(ngModel)]="selectedProduct.imageUrl"
            name="imageUrl"
            required
            class="form-input"
          />
        </div>

        <div class="form-group">
          <label for="updateClient" class="form-label">Client Name</label>
          <input
            id="updateClient"
            type="text"
            [(ngModel)]="selectedProduct.clientName"
            name="clientName"
            required
            class="form-input"
            readonly
            title="client name cannot be changed "
            disabled
          />
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-secondary" (click)="closeUpdateModal()">
            Cancel
          </button>
          <button type="submit" class="btn-primary">
            <span class="btn-icon">üíæ</span>
            Update Product
          </button>
        </div>
      </form>
    </div>
  }


  <!-- Loading State -->
  @if (loading) {
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p class="loading-text">Loading products...</p>
    </div>
  }

  <!-- Product Grid -->
  @if (!loading && products.length > 0) {
    <div class="product-grid">
      @for (product of products; track product.id) {
        <div class="product-card">
          <!-- Image -->
          <div class="product-image">
            @if (product.imageUrl) {
              <img [src]="product.imageUrl" alt="{{ product.name }}" class="product-img" />
            } @else {
              <div class="product-placeholder">{{ product.name[0] }}</div>
            }
          </div>

          <!-- Name -->
          <h2 class="product-name">{{ product.name }}</h2>

          <!-- Barcode + Client (inline) -->
          <div class="barcode-client">
            <span class="product-barcode">{{ product.barcode }}</span>
            <span class="separator">‚Ä¢</span>
            <span class="product-client">{{ product.clientName }}</span>
          </div>

          <!-- Details -->
          <div class="product-details">
            <div class="detail-row">
              <span class="detail-label">Price:</span>
              <span class="detail-value price">‚Çπ{{ product.price }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Quantity:</span>
              <span
                class="detail-value quantity"
                [class.low]="product.quantity < 5"
              >
        {{ product.quantity }}
      </span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Status:</span>
              <span
                class="product-status"
                [class.in-stock]="product.quantity > 0"
                [class.out-of-stock]="product.quantity === 0"
              >
        {{ product.quantity > 0 ? 'In Stock' : 'Out of Stock' }}
      </span>
            </div>
          </div>

          <!-- Footer with Edit Button -->
          @if (isSupervisor) {
          <div class="product-footer">
            <button class="action-btn edit-btn" (click)="openUpdateModal(product)">
              <span class="btn-icon">‚úèÔ∏è</span> Edit
            </button>
          </div>
          }
        </div>
      }
    </div>

    <!-- Pagination -->
    <div class="pagination-container">
      <div class="pagination-info">
        <span class="page-info">Page {{ page + 1 }} of {{ totalPages }}</span>
        <span class="total-info">Showing {{ products.length }} products</span>
      </div>
      <div class="pagination-controls">
        <button
          class="pagination-btn"
          (click)="prevPage()"
          [disabled]="page === 0"
          [class.disabled]="page === 0">
          <span class="btn-icon">‚Üê</span>
          Previous
        </button>
        <button
          class="pagination-btn"
          (click)="nextPage()"
          [disabled]="page >= totalPages - 1"
          [class.disabled]="page >= totalPages - 1">
          Next
          <span class="btn-icon">‚Üí</span>
        </button>
      </div>
    </div>
  }

</div>
